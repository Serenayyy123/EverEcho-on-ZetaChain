# 孤儿奖励修复需求文档

## 介绍

当前系统中存在跨链奖励与任务关联失败的问题，导致奖励成为"孤儿奖励"（taskId=0），用户资金被锁定但无法在任务详情页显示。本文档定义了修复此问题的需求。

## 术语表

- **孤儿奖励 (Orphan Reward)**: taskId为0的奖励记录，表示奖励创建成功但未正确关联到任务
- **UniversalReward合约**: ZetaChain上管理跨链奖励的智能合约
- **TaskEscrow合约**: 管理任务生命周期的智能合约
- **lockForTask函数**: UniversalReward合约中将奖励关联到任务的函数
- **原子化操作**: 确保跨链奖励创建和任务创建在同一流程中完成的机制

## 需求

### 需求 1: 孤儿奖励清理

**用户故事**: 作为系统管理员，我希望能够清理现有的孤儿奖励，以便用户可以收回被锁定的资金。

#### 验收标准

1. WHEN 系统检测到taskId为0的奖励记录 THEN 系统SHALL提供退款机制将资金返还给创建者
2. WHEN 执行批量退款操作 THEN 系统SHALL确保所有孤儿奖励都被正确处理
3. WHEN 退款完成 THEN 系统SHALL验证奖励状态已更新为Refunded
4. WHEN 退款操作失败 THEN 系统SHALL记录错误并提供重试机制
5. WHEN 退款成功 THEN 系统SHALL通知相关用户资金已返还

### 需求 2: 任务关联流程修复

**用户故事**: 作为用户，我希望创建跨链奖励时能够确保奖励正确关联到任务，避免资金被锁定在孤儿状态。

#### 验收标准

1. WHEN 用户创建跨链奖励 THEN 系统SHALL确保奖励创建和任务关联在原子化操作中完成
2. WHEN 任务创建成功 THEN 系统SHALL自动调用lockForTask函数将奖励关联到任务
3. WHEN lockForTask调用失败 THEN 系统SHALL回滚整个操作并退还用户资金
4. WHEN 奖励成功关联到任务 THEN getRewardByTask函数SHALL返回正确的奖励ID
5. WHEN 关联完成 THEN 任务详情页SHALL正确显示跨链奖励信息

### 需求 3: 错误处理和用户反馈

**用户故事**: 作为用户，我希望在跨链奖励创建过程中遇到问题时能够得到清晰的错误信息和解决方案。

#### 验收标准

1. WHEN 跨链奖励创建失败 THEN 系统SHALL提供具体的错误原因和建议解决方案
2. WHEN 任务关联失败 THEN 系统SHALL自动触发退款流程
3. WHEN 网络切换失败 THEN 系统SHALL指导用户手动切换到正确网络
4. WHEN 余额不足 THEN 系统SHALL明确告知用户需要的资金数量
5. WHEN 操作超时 THEN 系统SHALL提供重试选项

### 需求 4: 预防机制

**用户故事**: 作为系统开发者，我希望建立预防机制避免未来再次出现孤儿奖励问题。

#### 验收标准

1. WHEN 系统启动 THEN 系统SHALL检查并报告任何现有的孤儿奖励
2. WHEN 创建跨链奖励 THEN 系统SHALL验证所有前置条件都满足
3. WHEN 检测到异常状态 THEN 系统SHALL记录详细日志用于问题诊断
4. WHEN 用户操作中断 THEN 系统SHALL提供恢复机制
5. WHEN 合约调用失败 THEN 系统SHALL实施自动重试和降级策略

### 需求 5: 监控和告警

**用户故事**: 作为系统运维人员，我希望能够监控跨链奖励的健康状态并在出现问题时及时收到告警。

#### 验收标准

1. WHEN 检测到新的孤儿奖励 THEN 系统SHALL发送告警通知
2. WHEN 孤儿奖励数量超过阈值 THEN 系统SHALL触发紧急处理流程
3. WHEN 用户报告跨链奖励问题 THEN 系统SHALL提供诊断工具
4. WHEN 系统执行清理操作 THEN 系统SHALL生成详细的操作报告
5. WHEN 监控发现异常模式 THEN 系统SHALL自动暂停相关功能并通知管理员