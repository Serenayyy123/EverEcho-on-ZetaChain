# 跨链奖励使用指南

## 🎯 概述

跨链奖励系统现在已经完全集成真实的区块链交互。用户可以通过 MetaMask 钱包进行真实的资金操作，系统会正确处理所有的合约调用和状态同步。

## 🚀 快速开始

### 1. 启动系统

```bash
# 启动本地区块链（如果还没有运行）
npm run dev:blockchain

# 启动前端
npm run dev:frontend
```

### 2. 配置 MetaMask

1. 连接到本地网络 (localhost:8545, Chain ID: 31337)
2. 导入测试账户私钥：`ac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80`
3. 确保账户有足够的 ETH 余额

## 👤 用户流程

### Creator（任务发布者）流程

#### 1. 发布带跨链奖励的任务

1. **访问发布任务页面**
   - 打开 `/publish` 页面
   - 填写基本任务信息

2. **启用跨链奖励**
   - 点击"跨链奖励 (可选)"开关
   - 展开跨链奖励配置面板

3. **配置奖励参数**
   - **奖励资产**: 选择 ETH 或其他支持的代币
   - **奖励数量**: 输入奖励金额（如 0.01 ETH）
   - **目标链**: 选择目标区块链网络

4. **准备奖励计划**
   - 点击"准备跨链奖励"按钮
   - **MetaMask 弹出**: 确认交易（Gas 费用很低）
   - 等待交易确认
   - 状态变为"已准备"

5. **存入资金**
   - 点击"存入资金"按钮
   - **MetaMask 弹出**: 确认 ETH 转账（金额 = 奖励数量）
   - 等待交易确认
   - 状态变为"已准备就绪"

6. **发布任务**
   - 点击"发布任务"按钮
   - 系统自动锁定跨链奖励给该任务
   - 任务成功发布

#### 2. 管理跨链奖励

- **发布前**: 可以随时撤回资金
- **发布后**: 资金被锁定，无法撤回
- **任务取消**: 系统会引导退款流程

### Helper（任务执行者）流程

#### 1. 查看跨链奖励

1. **浏览任务**
   - 在任务列表中查看带有跨链奖励标识的任务
   - 点击进入任务详情页

2. **查看奖励信息**
   - 在任务详情页面查看"跨链奖励"模块
   - 显示奖励金额、资产类型、目标链等信息

#### 2. 完成任务并领取奖励

1. **正常完成任务**
   - 接受任务 → 提交作品 → 等待确认
   - 按照正常的 ECHO 任务流程操作

2. **领取跨链奖励**
   - 任务完成后，"跨链奖励"模块显示"可以领取跨链奖励"
   - 点击"Withdraw 奖励"按钮
   - **MetaMask 弹出**: 确认交易
   - 等待跨链转账完成
   - 奖励直接发送到您的钱包地址

## 🔧 技术细节

### 合约地址
- **本地环境**: `0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512`
- **ZetaChain Athens**: 待部署

### 支持的资产
- **ETH**: 原生以太坊（地址: `0x0000000000000000000000000000000000000000`）
- **USDT**: 模拟 USDT 代币（地址: `0x1234567890123456789012345678901234567890`）

### 支持的目标链
- **Sepolia Testnet** (Chain ID: 11155111)
- **Ethereum Mainnet** (Chain ID: 1)
- **ZetaChain Athens** (Chain ID: 7001)

### 奖励状态
- **Prepared** (0): 计划创建，未存款
- **Deposited** (1): 已存款，可撤回
- **Locked** (2): 已锁定给任务，不可撤回
- **Claimed** (3): 已被 Helper 领取
- **Refunded** (4): 已退款给 Creator
- **Reverted** (5): 跨链失败，等待退款

## 🛠️ 故障排除

### 常见问题

#### 1. MetaMask 没有弹出
- **原因**: 钱包未连接或网络不匹配
- **解决**: 确保 MetaMask 连接到正确的网络 (localhost:8545)

#### 2. 余额不足错误
- **原因**: 账户 ETH 余额不够支付奖励金额 + Gas 费
- **解决**: 确保账户有足够的 ETH 余额

#### 3. 交易失败
- **原因**: Gas 费用不足或合约调用失败
- **解决**: 增加 Gas 限制或检查合约状态

#### 4. 找不到跨链奖励
- **原因**: 任务没有配置跨链奖励或合约查询失败
- **解决**: 检查网络连接和合约地址配置

### 错误代码

- **"请先连接钱包"**: 需要连接 MetaMask
- **"余额不足"**: ETH 余额不够
- **"Invalid status"**: 奖励状态不允许该操作
- **"Unauthorized"**: 没有权限执行该操作

## 🧪 测试场景

### 完整测试流程

1. **准备环境**
   ```bash
   npm run dev:blockchain
   npm run dev:frontend
   ```

2. **测试 Creator 流程**
   - 连接 MetaMask (Account #0)
   - 发布带跨链奖励的任务
   - 验证 MetaMask 交互
   - 检查余额变化

3. **测试 Helper 流程**
   - 切换到另一个账户 (Account #1)
   - 完成任务
   - 领取跨链奖励
   - 验证资金到账

4. **测试错误场景**
   - 余额不足时的错误处理
   - 网络断开时的重试机制
   - 交易失败时的状态恢复

### 验证脚本

```bash
# 验证系统配置
npx tsx scripts/verifyCrossChainRewardFix.ts

# 测试合约交互
npx tsx scripts/testCrossChainRewardIntegration.ts
```

## 📊 监控和调试

### 浏览器控制台
- 查看详细的合约调用日志
- 监控交易状态和错误信息
- 检查钱包连接状态

### MetaMask 活动
- 查看交易历史
- 确认交易状态
- 检查 Gas 费用

### 网络请求
- 监控 RPC 调用
- 检查合约查询结果
- 验证事件解析

## 🎉 成功指标

系统正常工作的标志：

1. ✅ **钱包交互**: MetaMask 正确弹出交易确认
2. ✅ **余额更新**: 交易后余额正确变化
3. ✅ **状态同步**: 前端状态与链上状态一致
4. ✅ **错误处理**: 错误情况下有清晰的提示
5. ✅ **用户体验**: 操作流程顺畅，反馈及时

---

**注意**: 这是测试环境的使用指南。在生产环境中，请确保使用正确的网络配置和合约地址。