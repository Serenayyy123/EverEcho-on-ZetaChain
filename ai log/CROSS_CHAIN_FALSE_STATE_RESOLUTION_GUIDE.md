# è·¨é“¾å¥–åŠ±è™šå‡çŠ¶æ€è§£å†³æŒ‡å—

## ğŸš¨ é—®é¢˜æè¿°

ç”¨æˆ·åœ¨ç‚¹å‡»å‘å¸ƒä»»åŠ¡æ—¶çœ‹åˆ°è·¨é“¾èµ„äº§æ˜¾ç¤ºï¼Œä½†å®é™…ä¸Šæ²¡æœ‰å­˜å…¥ä»»ä½•èµ„é‡‘ã€‚è¿™æ˜¯ç”±äº CrossChainDraftStore çš„æŒä¹…åŒ–æœºåˆ¶å¯¼è‡´çš„è™šå‡çŠ¶æ€æ¢å¤ã€‚

## ğŸ” é—®é¢˜åŸå› 

1. **æŒä¹…åŒ–å­˜å‚¨æœºåˆ¶**: CrossChainDraftStore ä¼šå°†è·¨é“¾å¥–åŠ±çŠ¶æ€ä¿å­˜åˆ° localStorage
2. **çŠ¶æ€æ¢å¤é€»è¾‘**: é¡µé¢åˆ·æ–°æ—¶ä¼šè‡ªåŠ¨æ¢å¤ä¹‹å‰çš„çŠ¶æ€
3. **æ—¶é—´çª—å£è¿‡é•¿**: åŸæ¥çš„30åˆ†é’Ÿæ¢å¤çª—å£å¤ªé•¿ï¼Œå®¹æ˜“æ¢å¤è¿‡æœŸçŠ¶æ€
4. **ç¼ºä¹ç”¨æˆ·ç¡®è®¤**: æ²¡æœ‰è¯¢é—®ç”¨æˆ·æ˜¯å¦çœŸçš„å­˜å…¥äº†èµ„é‡‘

## âœ… å·²å®æ–½çš„ä¿®å¤

### 1. ç¼©çŸ­æ¢å¤æ—¶é—´çª—å£
- ä»30åˆ†é’Ÿç¼©çŸ­åˆ°3åˆ†é’Ÿ
- å‡å°‘æ¢å¤è¿‡æœŸçŠ¶æ€çš„å¯èƒ½æ€§

### 2. æ·»åŠ ç”¨æˆ·ç¡®è®¤å¯¹è¯æ¡†
```typescript
setTimeout(() => {
  const userConfirm = window.confirm(
    'æ£€æµ‹åˆ°ä¹‹å‰çš„è·¨é“¾å¥–åŠ±çŠ¶æ€ã€‚\n\n' +
    'å¦‚æœæ‚¨ç¡®å®åœ¨3åˆ†é’Ÿå†…å­˜å…¥äº†è·¨é“¾å¥–åŠ±ï¼Œè¯·ç‚¹å‡»"ç¡®å®š"ç»§ç»­ã€‚\n' +
    'å¦‚æœæ‚¨æ²¡æœ‰å®é™…å­˜å…¥å¥–åŠ±ï¼Œè¯·ç‚¹å‡»"å–æ¶ˆ"æ¸…ç†çŠ¶æ€ã€‚'
  );
  
  if (!userConfirm) {
    draftStore.reset();
    setRewardPlan(prev => ({ /* é‡ç½®çŠ¶æ€ */ }));
  }
}, 1000);
```

### 3. æ”¹è¿›é‡ç½®æŒ‰é’®ç•Œé¢
- æ›´é†’ç›®çš„è­¦å‘Šæ ·å¼
- ä¸¤ä¸ªæ“ä½œæŒ‰é’®ï¼šæ¸…ç†çŠ¶æ€ + å¼ºåˆ¶åˆ·æ–°
- æ›´æ¸…æ™°çš„ç”¨æˆ·æŒ‡å¯¼

### 4. æ ‡è®°æ¢å¤çŠ¶æ€
- æ¢å¤çš„çŠ¶æ€æ ‡è®°ä¸º `rewardId: 'restored'`
- PublishTask å¿½ç•¥æ¢å¤çŠ¶æ€ï¼Œä¸è¿›è¡ŒåŸå­åŒ–æ“ä½œ
- é˜²æ­¢ä½¿ç”¨è™šå‡çŠ¶æ€å‘å¸ƒä»»åŠ¡

## ğŸ› ï¸ ç”¨æˆ·è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: ä½¿ç”¨ç•Œé¢é‡ç½®æŒ‰é’®
1. å¦‚æœçœ‹åˆ°è·¨é“¾å¥–åŠ±æ˜¾ç¤ºä¸º"å·²æ¢å¤çŠ¶æ€"
2. ç‚¹å‡»çº¢è‰²çš„"ğŸ§¹ æ¸…ç†è™šå‡çŠ¶æ€"æŒ‰é’®
3. æˆ–ç‚¹å‡»"ğŸ”„ å¼ºåˆ¶åˆ·æ–°é¡µé¢"æŒ‰é’®

### æ–¹æ¡ˆ2: æµè§ˆå™¨æ§åˆ¶å°æ¸…ç†
1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· (F12)
2. åˆ‡æ¢åˆ° Console æ ‡ç­¾
3. è¿è¡Œä»¥ä¸‹è„šæœ¬ï¼š

```javascript
// æ¸…ç†è·¨é“¾å¥–åŠ±çŠ¶æ€
localStorage.removeItem('everecho_crosschain_draft');
localStorage.removeItem('pendingRewardId');
console.log('âœ… å·²æ¸…ç†è·¨é“¾å¥–åŠ±çŠ¶æ€');
window.location.reload();
```

### æ–¹æ¡ˆ3: ä½¿ç”¨ä¸“ç”¨æ¸…ç†è„šæœ¬
è¿è¡Œé¡¹ç›®ä¸­çš„ `scripts/forceClearCrossChainState.js` è„šæœ¬

## ğŸ”§ å¼€å‘è€…è°ƒè¯•

### æ£€æŸ¥å½“å‰çŠ¶æ€
```javascript
// æŸ¥çœ‹å­˜å‚¨çš„çŠ¶æ€
const stored = localStorage.getItem('everecho_crosschain_draft');
if (stored) {
  console.log('å½“å‰çŠ¶æ€:', JSON.parse(stored));
} else {
  console.log('æ²¡æœ‰å­˜å‚¨çŠ¶æ€');
}
```

### æ‰‹åŠ¨è®¾ç½®æµ‹è¯•çŠ¶æ€
```javascript
// è®¾ç½®è™šå‡çŠ¶æ€ç”¨äºæµ‹è¯•
const fakeState = {
  enabled: true,
  asset: { key: 'ETH_SEPOLIA_NATIVE', displayName: 'ETH Sepolia', symbol: 'ETH', sourceChainId: 11155111, kind: 'native' },
  amount: '0.01',
  depositStatus: 'confirmed',
  lastUpdatedAt: Date.now() - 10 * 60 * 1000 // 10åˆ†é’Ÿå‰
};
localStorage.setItem('everecho_crosschain_draft', JSON.stringify(fakeState));
```

## ğŸ“Š ç›‘æ§å’Œé¢„é˜²

### 1. æ·»åŠ æ—¥å¿—è®°å½•
```typescript
// åœ¨çŠ¶æ€æ¢å¤æ—¶è®°å½•è¯¦ç»†ä¿¡æ¯
console.log('[CrossChainRewardSection] State restoration details:', {
  timeSinceUpdate: timeSinceUpdate,
  maxRestoreTime: MAX_RESTORE_TIME,
  willRestore: timeSinceUpdate < MAX_RESTORE_TIME,
  depositStatus: draft.depositStatus,
  hasRewardId: Boolean(draft.rewardId)
});
```

### 2. ç”¨æˆ·è¡Œä¸ºåˆ†æ
- è·Ÿè¸ªçŠ¶æ€æ¢å¤é¢‘ç‡
- ç›‘æ§ç”¨æˆ·é‡ç½®æ“ä½œ
- åˆ†æè™šå‡çŠ¶æ€äº§ç”Ÿæ¨¡å¼

### 3. æ”¹è¿›å»ºè®®
- è€ƒè™‘ä½¿ç”¨æ›´å¯é çš„çŠ¶æ€éªŒè¯æœºåˆ¶
- æ·»åŠ åŒºå—é“¾çŠ¶æ€éªŒè¯
- å®æ–½æ›´æ™ºèƒ½çš„çŠ¶æ€æ¢å¤é€»è¾‘

## ğŸš€ é•¿æœŸè§£å†³æ–¹æ¡ˆ

### 1. åŒºå—é“¾çŠ¶æ€éªŒè¯
```typescript
// éªŒè¯ rewardId åœ¨åŒºå—é“¾ä¸Šæ˜¯å¦çœŸå®å­˜åœ¨
const verifyRewardOnChain = async (rewardId: string) => {
  try {
    const contract = createUniversalRewardContract(signer, 7001);
    const reward = await contract.getReward(rewardId);
    return reward.amount > 0; // éªŒè¯å¥–åŠ±æ˜¯å¦å­˜åœ¨ä¸”æœ‰æ•ˆ
  } catch (error) {
    return false; // å¥–åŠ±ä¸å­˜åœ¨
  }
};
```

### 2. æ›´æ™ºèƒ½çš„æŒä¹…åŒ–ç­–ç•¥
- åªåœ¨çœŸæ­£æˆåŠŸå­˜å…¥åæ‰æŒä¹…åŒ–
- æ·»åŠ äº¤æ˜“å“ˆå¸ŒéªŒè¯
- å®æ–½çŠ¶æ€è¿‡æœŸæœºåˆ¶

### 3. ç”¨æˆ·ä½“éªŒæ”¹è¿›
- æ·»åŠ çŠ¶æ€æŒ‡ç¤ºå™¨
- æä¾›æ›´æ¸…æ™°çš„æ“ä½œæŒ‡å¯¼
- å®æ–½é˜²è¯¯æ“ä½œæœºåˆ¶

## ğŸ“ æµ‹è¯•æ¸…å•

- [ ] è™šå‡çŠ¶æ€èƒ½è¢«æ­£ç¡®è¯†åˆ«
- [ ] ç”¨æˆ·ç¡®è®¤å¯¹è¯æ¡†æ­£å¸¸å·¥ä½œ
- [ ] é‡ç½®æŒ‰é’®åŠŸèƒ½æ­£å¸¸
- [ ] å¼ºåˆ¶åˆ·æ–°æ¸…ç†çŠ¶æ€
- [ ] æ¢å¤çŠ¶æ€ä¸å½±å“ä»»åŠ¡å‘å¸ƒ
- [ ] æ—¶é—´çª—å£é™åˆ¶ç”Ÿæ•ˆ
- [ ] æ§åˆ¶å°æ¸…ç†è„šæœ¬æœ‰æ•ˆ

## ğŸ¯ æˆåŠŸæŒ‡æ ‡

- è™šå‡çŠ¶æ€æŠ•è¯‰å‡å°‘ > 90%
- ç”¨æˆ·èƒ½å¤Ÿè‡ªä¸»è§£å†³çŠ¶æ€é—®é¢˜
- çŠ¶æ€æ¢å¤å‡†ç¡®ç‡ > 95%
- ç”¨æˆ·æ»¡æ„åº¦æå‡

é€šè¿‡è¿™äº›ä¿®å¤å’Œæ”¹è¿›ï¼Œç”¨æˆ·åº”è¯¥èƒ½å¤Ÿè½»æ¾è¯†åˆ«å’Œæ¸…ç†è™šå‡çš„è·¨é“¾å¥–åŠ±çŠ¶æ€ã€‚