# P0-F1 钱包连接与注册 — 实现总结

## ✅ 已完成

P0-F1 钱包连接与注册前端模块已完整实现，所有冻结点和验收口径 100% 达成。

---

## 1. 关键设计说明

### 1.1 技术选型

**前端框架**：React 18 + TypeScript + Vite
- 现代化开发体验
- 类型安全
- 快速热更新

**钱包连接**：ethers.js v6 + window.ethereum
- 使用 BrowserProvider 连接 MetaMask
- 支持账户切换和网络切换监听

**加密库**：tweetnacl
- x25519 密钥对生成
- 与 backend 加密服务一致

**路由**：React Router v6
- 简洁的路由配置
- 支持编程式导航

### 1.2 核心流程

**钱包连接流程**：
```
访问首页 → Connect Wallet
→ MetaMask 授权
→ 获取 address + signer
→ 检查 Register.isRegistered(address)
→ 已注册 → /tasks
→ 未注册 → /register
```

**注册流程（严格遵守冻结点 2.2-P0-F1）**：
```
1. 填写表单（nickname, city, skills）
2. 生成加密密钥对（tweetnacl）
3. 构造 Profile 数据（含 encryptionPubKey）
4. POST /api/profile → 获得 profileURI
5. 调用 Register.register(profileURI)
6. 等待交易确认
7. 保存私钥到 localStorage
8. 跳转 /tasks
```

### 1.3 加密密钥生成

使用 **tweetnacl** (x25519)：

```typescript
const keyPair = nacl.box.keyPair();
const publicKey = Buffer.from(keyPair.publicKey).toString('hex');
const privateKey = Buffer.from(keyPair.secretKey).toString('hex');
```

- **publicKey**：上传到 backend（Profile.encryptionPubKey）
- **privateKey**：保存到 localStorage（MVP 简化实现）

---

## 2. 文件清单

### 核心 Hooks
- ✅ `frontend/src/hooks/useWallet.ts` - 钱包连接 Hook
  - connect() - 连接 MetaMask
  - disconnect() - 断开连接
  - 监听账户/网络切换
  - 自动重连

- ✅ `frontend/src/hooks/useRegister.ts` - 注册 Hook
  - checkRegistered() - 检查注册状态
  - register() - 执行注册流程

### 页面组件
- ✅ `frontend/src/pages/Home.tsx` - 首页（钱包连接）
- ✅ `frontend/src/pages/Register.tsx` - 注册页
- ✅ `frontend/src/pages/TaskSquare.tsx` - 任务广场（占位）

### 工具函数
- ✅ `frontend/src/utils/api.ts` - Backend API 调用
  - uploadProfile() - 上传 Profile
  - getProfile() - 获取 Profile

- ✅ `frontend/src/utils/encryption.ts` - 加密工具
  - generateEncryptionKeyPair() - 生成密钥对
  - saveEncryptionPrivateKey() - 保存私钥
  - loadEncryptionPrivateKey() - 加载私钥

### 合约配置
- ✅ `frontend/src/contracts/Register.json` - Register 合约 ABI
- ✅ `frontend/src/contracts/addresses.ts` - 合约地址配置

### 配置文件
- ✅ `frontend/package.json` - 依赖配置
- ✅ `frontend/vite.config.ts` - Vite 配置
- ✅ `frontend/tsconfig.json` - TypeScript 配置
- ✅ `frontend/.env.example` - 环境变量示例

### 文档
- ✅ `frontend/README.md` - 使用文档
- ✅ `P0-F1_实现总结.md` - 本文档

---

## 3. 冻结点遵守

### 3.1 冻结点 1.1-1 / 1.1-4 / 1.1-5：三合约分层

✅ **前端只调用 Register.register(profileURI)**
- 证据：`useRegister.ts:78-82`
```typescript
const registerContract = new Contract(
  REGISTER_ADDRESS,
  RegisterABI.abi,
  signer
);
const tx = await registerContract.register(profileURI);
```

✅ **不直接调用 EOCHOToken.mintInitial**
- 证据：代码中无 EOCHOToken 合约调用

✅ **合约间依赖已部署好，前端只按 ABI 调用**
- 证据：`addresses.ts` 配置合约地址
- 证据：`Register.json` 包含完整 ABI

### 3.2 冻结点 1.4-22：Profile JSON schema 必填字段

✅ **nickname, city, skills, encryptionPubKey**
- 证据：`useRegister.ts:58-64`
```typescript
const profileData: ProfileData = {
  address,
  nickname: formData.nickname,
  city: formData.city,
  skills: formData.skills,
  encryptionPubKey: publicKey,
};
```

✅ **POST /api/profile 前保证字段齐全**
- 证据：`Register.tsx:48-60` - 表单验证
- 证据：`useRegister.ts:52-54` - 生成 encryptionPubKey

### 3.3 冻结点 2.2-P0-F1：流程固定

✅ **1) 连接钱包 → 检查 isRegistered**
- 证据：`Home.tsx:17-34`
```typescript
const checkAndRedirect = async () => {
  const isRegistered = await checkRegistered(address);
  if (isRegistered) {
    navigate('/tasks');
  } else {
    navigate('/register');
  }
};
```

✅ **2) 未注册 → 填表 → 先上传 profile 到 backend**
- 证据：`useRegister.ts:67-69`
```typescript
const profileURI = await uploadProfile(profileData);
```

✅ **3) backend 返回 profileURI**
- 证据：`api.ts:35-39`
```typescript
if (!data.profileURI) {
  throw new Error('Backend did not return profileURI');
}
return data.profileURI;
```

✅ **4) 前端调用 Register.register(profileURI)**
- 证据：`useRegister.ts:78-82`

✅ **5) 成功后跳转 TaskSquare**
- 证据：`Register.tsx:68`
```typescript
navigate('/tasks');
```

### 3.4 冻结点 3.2：JSON 字段命名一致

✅ **使用标准字段名，无变体**
- 证据：`api.ts:11-17` - ProfileData 接口定义
- 字段：address, nickname, city, skills, encryptionPubKey

---

## 4. 验收口径达成

### 4.1 Home 页可连接 MetaMask

✅ **实现**：`Home.tsx:46-56`
```typescript
<button onClick={connect} disabled={isConnecting}>
  {isConnecting ? 'Connecting...' : 'Connect Wallet'}
</button>
```

✅ **支持 EIP-1193 钱包**
- 证据：`useWallet.ts:28-30` - 检查 window.ethereum

### 4.2 连接后读取地址并检查 Register.isRegistered(address)

✅ **实现**：`useRegister.ts:24-38`
```typescript
const checkRegistered = useCallback(async (address: string): Promise<boolean> => {
  const registerContract = new Contract(
    REGISTER_ADDRESS,
    RegisterABI.abi,
    signer
  );
  const isRegistered = await registerContract.isRegistered(address);
  return isRegistered;
}, [signer]);
```

### 4.3 已注册：直接跳转 /tasks

✅ **实现**：`Home.tsx:23-26`
```typescript
if (isRegistered) {
  console.log('User already registered, redirecting to tasks...');
  navigate('/tasks');
}
```

### 4.4 未注册：跳转 /register

✅ **实现**：`Home.tsx:27-30`
```typescript
else {
  console.log('User not registered, redirecting to register...');
  navigate('/register');
}
```

### 4.5 Register 页表单字段完整

✅ **nickname**：`Register.tsx:95-106`
✅ **city**：`Register.tsx:108-119`
✅ **skills**：`Register.tsx:121-145`

### 4.6 注册时生成 encryptionPubKey

✅ **实现**：`useRegister.ts:52-54`
```typescript
const { publicKey, privateKey } = generateEncryptionKeyPair();
```

✅ **使用 tweetnacl**：`encryption.ts:13-21`

### 4.7 提交链路严格执行

✅ **POST /api/profile → 获得 profileURI**
- 证据：`useRegister.ts:67-69`

✅ **调用 Register.register(profileURI)**
- 证据：`useRegister.ts:78-82`

### 4.8 任一环节失败有明确错误提示

✅ **表单验证错误**：`Register.tsx:48-60`
✅ **注册错误**：`Register.tsx:159-163`
✅ **钱包连接错误**：`Home.tsx:58-62`

### 4.9 不实现 profile 更新入口

✅ **无 profile 更新功能**
- 证据：代码中无 profile 更新相关路由和组件

### 4.10 不实现其它页面业务

✅ **TaskSquare 只是占位页**
- 证据：`TaskSquare.tsx` - 仅显示欢迎信息

---

## 5. 如何本地运行

### 5.1 安装依赖

```bash
cd frontend
npm install
```

### 5.2 配置环境变量

```bash
cp .env.example .env
```

编辑 `.env`：

```env
VITE_API_URL=http://localhost:3000
VITE_REGISTER_ADDRESS=0x5FbDB2315678afecb367f032d93F642f64180aa3
VITE_EOCHO_TOKEN_ADDRESS=0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512
VITE_TASK_ESCROW_ADDRESS=0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0
VITE_CHAIN_ID=31337
VITE_NETWORK_NAME=Localhost
```

### 5.3 启动开发服务器

```bash
npm run dev
```

访问 http://localhost:5173

### 5.4 确保 Backend 运行

```bash
cd backend
npm run dev
```

Backend 应该运行在 http://localhost:3000

### 5.5 确保合约已部署

使用 Hardhat 部署合约到本地网络：

```bash
npx hardhat node
npx hardhat run scripts/deploy.ts --network localhost
```

更新 `.env` 中的合约地址

---

## 6. 测试流程

### 6.1 钱包连接测试

1. 访问 http://localhost:5173
2. 点击 "Connect Wallet"
3. MetaMask 弹窗授权
4. 确认连接成功，显示地址

### 6.2 注册测试（未注册用户）

1. 连接钱包后自动跳转到 /register
2. 填写表单：
   - Nickname: Alice
   - City: Beijing
   - Skills: 选择 2-3 个技能
3. 点击 "Register"
4. MetaMask 弹窗确认交易
5. 等待交易确认
6. 自动跳转到 /tasks

### 6.3 注册测试（已注册用户）

1. 使用已注册的地址连接钱包
2. 自动跳转到 /tasks
3. 显示欢迎信息

---

## 7. 常见问题

### Q1: MetaMask 未安装

**错误**：`Please install MetaMask`

**解决**：安装 MetaMask 浏览器扩展

### Q2: 合约地址未配置

**错误**：`Contract call failed`

**解决**：在 `.env` 中配置正确的合约地址

### Q3: Backend 未运行

**错误**：`Failed to fetch`

**解决**：启动 backend 服务

### Q4: 网络不匹配

**错误**：`Wrong network`

**解决**：在 MetaMask 中切换到正确的网络

---

## 8. 最终结论

✅ **P0-F1 钱包连接与注册完全实现**

- 冻结点命中率：**100%** (4/4)
- 验收口径达成率：**100%** (10/10)
- 代码质量：**TypeScript 类型安全**
- 用户体验：**清晰的错误提示和加载状态**

**可立即投入使用，支持后续薄片开发。**

---

## 9. 下一步

P0-F1 完成后，后续薄片将实现：

- **P0-F2**：任务广场（浏览任务）
- **P0-F3**：发布任务
- **P0-F4**：接取任务
- **P1-F5**：Contacts 加密/解密

详细文档见：`frontend/README.md`
