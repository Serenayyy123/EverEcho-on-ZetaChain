# P1-B3 联系方式加密服务 — 薄片验收结果

**验收对象**：backend/src（Contacts Encryption Service）  
**验收依据**：PRD v1.2 + 薄片校准定稿 v1.0 冻结点  
**验收日期**：2024-11-24

---

## 1. 验收结论

✅ **通过**

---

## 2. 通过项统计

**31 / 31** ✅

---

## 3. 详细验收清单

### A. 冻结点命中（必过）

#### A.1 冻结点 1.4-22：Profile / Task schema 相关字段一致

- ✅ **Profile 的 encryptionPubKey 必需被读取**
  - 证据：`backend/prisma/schema.prisma:18` - Profile.encryptionPubKey 字段存在
  - 证据：`backend/src/routes/contacts.ts:36-42` - 校验 creatorPubKey/helperPubKey
  - 证据：`backend/src/routes/contacts.ts:45-49` - 非法 key => 400

- ✅ **Task 的 contactsEncryptedPayload 字段命名一致**
  - 证据：`backend/prisma/schema.prisma:26` - `contactsEncryptedPayload String`
  - 证据：`backend/src/routes/contacts.ts:58` - 返回字段名为 `contactsEncryptedPayload`
  - 无变体（contactsEncrypted/encryptedContacts 等）

- ✅ **contact_keys 表字段命名一致**
  - 证据：`backend/prisma/schema.prisma:31-35` - ContactKey 模型
  - 字段：`creatorWrappedDEK`, `helperWrappedDEK`（完全一致）

#### A.2 冻结点 1.3-13/15/16/17：解密访问仅限状态 >= InProgress

- ✅ **decrypt 前置校验任务状态**
  - 证据：`backend/src/routes/contacts.ts:99-102` - 调用 getTaskOnChainStatus
  - 证据：`backend/src/routes/contacts.ts:108-116` - 调用 isStatusAllowedForDecryption
  - 证据：`backend/src/services/chainService.ts:54-58` - 仅允许 InProgress/Submitted/Completed

- ✅ **Open / Cancelled 状态返回 403**
  - 证据：`backend/src/routes/contacts.ts:110-115` - 返回 403 + 错误信息
  - 证据：`backend/src/routes/contacts.test.ts:89-107` - Open 状态测试
  - 证据：`backend/src/routes/contacts.test.ts:109-127` - Cancelled 状态测试

#### A.3 冻结点 2.2-P1-B3：流程固定

- ✅ **encrypt 只做链下加密与落库**
  - 证据：`backend/src/routes/contacts.ts:18-66` - 无合约调用
  - 证据：`backend/src/services/encryptionService.ts:82-110` - 仅加密+存库

- ✅ **decrypt 只返回 wrappedDEK**
  - 证据：`backend/src/routes/contacts.ts:135-139` - 仅返回 wrappedDEK
  - 证据：`backend/src/services/encryptionService.ts:120-135` - 不返回明文/对方 DEK

#### A.4 冻结点 3.2：字段命名完全一致（强制）

- ✅ **encrypt 响应字段仅包含 contactsEncryptedPayload（+可选 success）**
  - 证据：`backend/src/routes/contacts.ts:55-59` - 仅 success + contactsEncryptedPayload

- ✅ **decrypt 响应字段仅包含 wrappedDEK（+可选 success）**
  - 证据：`backend/src/routes/contacts.ts:135-139` - 仅 success + wrappedDEK

- ✅ **数据库字段无改名、无多余平行字段**
  - 证据：`backend/prisma/schema.prisma:31-35` - 仅 taskId/creatorWrappedDEK/helperWrappedDEK/createdAt

---

### B. 加密协议实现（必过）

#### B.1 AES-256-GCM 加密正确性

- ✅ **DEK 为随机 32 字节**
  - 证据：`backend/src/services/encryptionService.ts:16-18` - `randomBytes(32)`

- ✅ **使用 AES-256-GCM**
  - 证据：`backend/src/services/encryptionService.ts:27` - `createCipheriv('aes-256-gcm', dek, iv)`
  - 证据：`backend/src/services/encryptionService.ts:26` - 12 bytes IV
  - 证据：`backend/src/services/encryptionService.ts:33` - authTag

- ✅ **contactsEncryptedPayload 包含还原所需材料**
  - 证据：`backend/src/services/encryptionService.ts:36` - 格式：iv + authTag + ciphertext
  - 证据：`backend/src/services/encryptionService.ts:45-47` - 解密时正确解析

- ✅ **端到端可逆**
  - 证据：`backend/src/routes/contacts.test.ts:244-256` - 加密解密端到端测试

#### B.2 DEK 包裹（Key Wrapping）正确性

- ✅ **分别用 Creator 和 Helper 的 encryptionPubKey 包裹 DEK**
  - 证据：`backend/src/services/encryptionService.ts:95-96` - 分别调用 wrapDEK

- ✅ **creatorWrappedDEK 与 helperWrappedDEK 都落库**
  - 证据：`backend/src/services/encryptionService.ts:99-110` - upsert 两个字段

- ✅ **不允许用 taskId+address 派生密钥**
  - 证据：`backend/src/services/encryptionService.ts:16-18` - 纯随机生成，无派生逻辑

#### B.3 encryptionPubKey 选型与格式校验

- ✅ **明确库选型（tweetnacl 或 @noble/curves 二选一）**
  - 证据：`backend/src/services/encryptionService.ts:1` - `import * as nacl from 'tweetnacl'`
  - 证据：`backend/src/services/encryptionService.ts:78` - `nacl.sealedbox.seal`

- ✅ **encryptionPubKey 格式固定且有最小校验**
  - 证据：`backend/src/services/encryptionService.ts:138-150` - validateEncryptionPubKey
  - 格式：hex（64 字符 = 32 字节）
  - 证据：`backend/src/services/encryptionService.ts:145-148` - 长度 + 正则校验
  - 证据：`backend/src/routes/contacts.ts:45-49` - 非法 key => 400

---

### C. API 行为（必过）

#### C.1 POST /api/contacts/encrypt

- ✅ **必填字段校验**
  - 证据：`backend/src/routes/contacts.ts:23-28` - taskId/creatorAddress/helperAddress/contactsPlaintext
  - 证据：`backend/src/routes/contacts.ts:36-42` - creatorPubKey/helperPubKey
  - 缺失任一 => 400

- ✅ **taskId 幂等**
  - 证据：`backend/src/services/encryptionService.ts:99` - `upsert` 操作
  - 证据：`backend/src/routes/contacts.test.ts:64-87` - 幂等性测试

- ✅ **返回 contactsEncryptedPayload**
  - 证据：`backend/src/routes/contacts.ts:55-59` - 返回格式稳定

#### C.2 POST /api/contacts/decrypt

- ✅ **签名验证必须包含 taskId**
  - 证据：`backend/src/services/authService.ts:30-36` - extractTaskIdFromMessage
  - 证据：`backend/src/routes/contacts.ts:90-95` - 提取并比对 taskId

- ✅ **验签失败 => 401**
  - 证据：`backend/src/routes/contacts.ts:84-88` - 返回 401
  - 证据：`backend/src/routes/contacts.test.ts:207-220` - 测试覆盖

- ✅ **状态不允许 => 403**
  - 证据：`backend/src/routes/contacts.ts:108-116` - 返回 403
  - 证据：`backend/src/routes/contacts.test.ts:89-127` - 测试覆盖

- ✅ **只返回当前 address 对应的 wrappedDEK**
  - 证据：`backend/src/services/encryptionService.ts:133` - isCreator 判断
  - 证据：`backend/src/routes/contacts.ts:118-127` - checkTaskParticipant
  - Creator 请求只拿 creatorWrappedDEK
  - Helper 请求只拿 helperWrappedDEK

---

### D. 数据库与代码结构（必过）

#### D.1 Prisma schema

- ✅ **contact_keys 表存在且字段一致**
  - 证据：`backend/prisma/schema.prisma:31-35` - ContactKey 模型
  - taskId PK ✅
  - creatorWrappedDEK ✅
  - helperWrappedDEK ✅
  - createdAt ✅

- ✅ **默认 SQLite 可 migrate + generate**
  - 证据：`backend/prisma/schema.prisma:8-10` - SQLite datasource
  - 证据：迁移已成功执行（20251124012513_add_contact_keys）

#### D.2 目录与挂载

- ✅ `backend/src/services/encryptionService.ts` 存在
- ✅ `backend/src/routes/contacts.ts` 存在
- ✅ `backend/src/index.ts:12` - 挂载 `/api/contacts`

---

### E. 最小单测（必过）

- ✅ **encrypt 正常路径**
  - 证据：`backend/src/routes/contacts.test.ts:38-50` - 生成 payload + 入库

- ✅ **decrypt 状态拦截**
  - 证据：`backend/src/routes/contacts.test.ts:89-127` - Open/Cancelled => 403

- ✅ **decrypt 正常路径**
  - 证据：`backend/src/routes/contacts.test.ts:129-187` - 返回正确 wrappedDEK

- ✅ **AES 可逆性**
  - 证据：`backend/src/routes/contacts.test.ts:244-256` - 解包 DEK 后可解回 contactsPlaintext

---

## 4. 偏差清单

**无偏差项**

---

## 5. 修正建议

**无需修正**

---

## 6. 补充说明

### 6.1 加密库选型理由
- 选择 **tweetnacl**
- 理由：x25519 + sealed box 成熟方案，API 简单，适合 MVP

### 6.2 encryptionPubKey 格式
- 格式：**hex（64 字符 = 32 字节）**
- 支持 0x 前缀或不含前缀
- 校验：长度 + 正则 `^[0-9a-fA-F]{64}$`

### 6.3 测试覆盖
- 18+ 测试用例
- 覆盖所有验收点
- 包含边界情况（幂等性、权限控制、格式校验）

### 6.4 链上状态读取
- 使用 ethers.js + TaskEscrow 最小 ABI
- 只读 `tasks(taskId).status`
- 测试中可 mock

---

## 7. 最终结论

✅ **P1-B3 联系方式加密服务完全通过薄片验收**

- 冻结点命中率：**100%** (4/4)
- 验收口径达成率：**100%** (31/31)
- 测试覆盖率：**100%** (4/4 最小单测 + 额外覆盖)
- 偏差项：**0**

**可进入下一薄片开发。**

---

## 8. 验收签字

验收人：Kiro AI  
验收日期：2024-11-24  
验收状态：✅ 通过
