# 钱包断开修复 - 测试指南

## 🎯 测试目标

验证钱包断开修复是否正确工作，特别是确认**无限循环问题已修复**。

---

## 🚀 准备工作

### 1. 启动开发服务器

```bash
# 终端 1: 启动后端
cd backend
npm run dev

# 终端 2: 启动前端
cd frontend
npm run dev
```

### 2. 打开浏览器

访问: http://localhost:5173

### 3. 打开开发者工具

按 `F12` 打开浏览器开发者工具，切换到 **Console** 标签页。

---

## ✅ 测试清单

### 测试 1: 无限循环测试（最重要）

**目的**: 验证 v2 修复已解决无限循环问题

**步骤**:
1. 确保 MetaMask **未连接**
2. 清除浏览器控制台
3. 直接访问: http://localhost:5173/tasks
4. 观察页面和控制台

**预期结果**:
- ✅ 页面显示 "Please connect your wallet to view tasks"
- ✅ 页面**不会**自动跳转
- ✅ 控制台**没有**以下警告:
  ```
  Throttling navigation to prevent the browser from hanging.
  ```
- ✅ URL 保持在 `/tasks`

**如果失败**:
- ❌ 页面不断刷新或跳转
- ❌ 控制台出现 "Throttling navigation" 警告
- ❌ 浏览器变慢或卡顿

---

### 测试 2: 断开钱包测试

**目的**: 验证钱包断开时自动返回首页

**步骤**:
1. 连接 MetaMask 钱包
2. 访问 Profile 页面: http://localhost:5173/profile
3. 等待页面加载完成
4. 在 MetaMask 中点击 "Disconnect"
5. 观察页面变化

**预期结果**:
- ✅ 页面自动跳转到首页 `/`
- ✅ 跳转速度快（< 1 秒）
- ✅ 控制台无错误

**重复测试其他页面**:
- `/register` - Register 页面
- `/tasks` - TaskSquare 页面
- `/publish` - PublishTask 页面
- `/tasks/1` - TaskDetail 页面（任意任务 ID）

---

### 测试 3: 切换账户测试

**目的**: 验证切换账户不会触发导航

**步骤**:
1. 连接 MetaMask 钱包（账户 A）
2. 访问 Profile 页面
3. 在 MetaMask 中切换到另一个账户（账户 B）
4. 观察页面变化

**预期结果**:
- ✅ 页面**不会**跳转到首页
- ✅ 页面刷新并显示新账户的数据
- ✅ URL 保持在 `/profile`

---

### 测试 4: 初始连接测试

**目的**: 验证初始连接钱包不会触发导航

**步骤**:
1. 确保 MetaMask 未连接
2. 访问首页: http://localhost:5173
3. 点击 "Connect Wallet" 按钮
4. 在 MetaMask 中确认连接
5. 观察页面变化

**预期结果**:
- ✅ 连接成功后，根据注册状态跳转:
  - 已注册 → 跳转到 `/tasks`
  - 未注册 → 跳转到 `/register`
- ✅ 无异常导航
- ✅ 控制台无错误

---

### 测试 5: 刷新页面测试

**目的**: 验证刷新页面不会触发异常导航

**步骤**:
1. 连接钱包并访问 Profile 页面
2. 按 `F5` 刷新页面
3. 观察页面变化

**预期结果**:
- ✅ 页面正常刷新
- ✅ 保持在 Profile 页面
- ✅ 数据正常加载

---

### 测试 6: 网络切换测试

**目的**: 验证切换网络的行为

**步骤**:
1. 连接钱包（Sepolia 网络）
2. 访问 Profile 页面
3. 在 MetaMask 中切换到其他网络（如 Mainnet）
4. 观察页面变化

**预期结果**:
- ✅ 页面显示网络错误提示
- ✅ 不会跳转到首页
- ✅ 切换回 Sepolia 后恢复正常

---

## 📊 测试结果记录

### 测试环境
- 浏览器: _______________
- MetaMask 版本: _______________
- 测试日期: _______________

### 测试结果

| 测试项 | 状态 | 备注 |
|--------|------|------|
| 1. 无限循环测试 | ⬜ 通过 / ⬜ 失败 | |
| 2. 断开钱包测试 - Register | ⬜ 通过 / ⬜ 失败 | |
| 2. 断开钱包测试 - Profile | ⬜ 通过 / ⬜ 失败 | |
| 2. 断开钱包测试 - TaskSquare | ⬜ 通过 / ⬜ 失败 | |
| 2. 断开钱包测试 - PublishTask | ⬜ 通过 / ⬜ 失败 | |
| 2. 断开钱包测试 - TaskDetail | ⬜ 通过 / ⬜ 失败 | |
| 3. 切换账户测试 | ⬜ 通过 / ⬜ 失败 | |
| 4. 初始连接测试 | ⬜ 通过 / ⬜ 失败 | |
| 5. 刷新页面测试 | ⬜ 通过 / ⬜ 失败 | |
| 6. 网络切换测试 | ⬜ 通过 / ⬜ 失败 | |

---

## 🐛 常见问题

### Q1: 看到 "Throttling navigation" 警告
**原因**: 无限循环问题未修复  
**解决**: 检查是否使用了 v2 版本的代码（带 useRef）

### Q2: 断开钱包后没有跳转
**原因**: useEffect 可能没有正确触发  
**解决**: 检查 useEffect 依赖数组是否包含 `[address, navigate]`

### Q3: 切换账户时跳转到首页
**原因**: 逻辑错误，应该只在地址变为 null 时跳转  
**解决**: 检查条件是否为 `prevAddressRef.current && !address`

---

## ✅ 验收标准

所有测试项都必须通过才能认为修复成功：

- ✅ **无限循环测试通过** - 最重要
- ✅ 所有页面的断开钱包测试通过
- ✅ 切换账户测试通过
- ✅ 初始连接测试通过
- ✅ 刷新页面测试通过
- ✅ 网络切换测试通过

---

## 📝 测试报告模板

```
钱包断开修复测试报告

测试人员: _______________
测试日期: _______________
测试环境: _______________

测试结果:
- 无限循环测试: [通过/失败]
- 断开钱包测试: [通过/失败]
- 切换账户测试: [通过/失败]
- 初始连接测试: [通过/失败]
- 刷新页面测试: [通过/失败]
- 网络切换测试: [通过/失败]

总体评价: [通过/失败]

备注:
_______________
_______________
_______________

签名: _______________
```

---

**测试指南版本**: v2  
**最后更新**: 2024-11-24
