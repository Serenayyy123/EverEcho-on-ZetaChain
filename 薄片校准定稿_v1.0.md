# EverEcho MVP 薄片校准定稿 v1.0

**基于 PRD v1.2 最终冻结版**  
**校准日期**：2024-11-23  
**状态**：✅ 可直接驱动 vibe coding

---

## 1. 薄片校准定稿（22 条冻结点）

### 1.1 架构与权限边界（6 条）

1. **三合约分层架构**：独立 Register 合约，TaskEscrow 构造函数传入 Register 地址，EOCHO Token 存储 registerAddress 和 taskEscrowAddress
2. **mintInitial 权限**：仅 Register 合约可调用（onlyRegister modifier），外部地址不可直接调用
3. **burn 权限**：仅 TaskEscrow 合约可调用，EOCHO 内部存储 taskEscrowAddress（部署时由构造函数或一次性 setter 设定）
4. **isRegistered 验证**：TaskEscrow 通过 `registerContract.isRegistered(msg.sender)` 验证用户，不自行维护注册状态
5. **register() 唯一入口**：前端不得直接调用 mintInitial，register() 内部调用 mintInitial 是唯一路径
6. **EOCHO 继承 OZ ERC20**：不重复声明 balanceOf/totalSupply 等标准变量，仅扩展 hasMintedInitial/CAP/burn

### 1.2 Token 经济与常量（6 条）

7. **INITIAL_MINT**：`100 * 10**18`（每个新用户首次注册）
8. **CAP**：`10_000_000 * 10**18`（总量上限），CAP 已满时 mintInitial 返回 0 但不 revert，触发 CapReached 事件
9. **FEE_BPS**：`200`（2%），手续费计算公式：`fee = reward * FEE_BPS / 10000`（uint256 下取整），`helperReceived = reward - fee`
10. **MAX_REWARD**：`1000 * 10**18`（合约硬限制），createTask 前置条件：`reward > 0 && reward <= MAX_REWARD`
11. **CapReached 事件唯一触发源**：仅由 EOCHO Token 合约在 mintInitial() 内触发，Register 合约不重复触发
12. **burn 语义**：从 TaskEscrow 托管余额执行 `_burn(address(this), amount)`，不是从调用者余额销毁

### 1.3 状态机与资金流（6 条）

13. **状态枚举**：`enum TaskStatus { Open, InProgress, Submitted, Completed, Cancelled }`，状态流转：Open → InProgress → Submitted → Completed/Cancelled
14. **双向抵押**：Creator 发布任务抵押 R，Helper 接受任务抵押 R，资金锁定在 TaskEscrow 合约
15. **完成结算**：Helper 得 `0.98 * reward`，`0.02 * reward` burn，Helper 保证金 reward 全额退回；**合约托管总额为 2R，结算拆分必须严格按 Creator R 与 Helper R 两份执行，避免重复发放**
16. **InProgress 不可单方取消**：Creator 不可单方面取消，仅支持协商终止（双方同意）或超时
17. **Submitted 不可取消**：Creator 不可取消，仅支持 confirmComplete、requestFix（一次）、或超时自动完成
18. **超时资金流**：Open/InProgress 超时双方各拿回 R，Submitted 超时 Helper 得 0.98R + 保证金 R；**所有超时函数 any-callable，Gas 由触发者自付（MVP 无第三方激励）**

### 1.4 超时与链下 schema（4 条）

19. **超时常量**：`T_OPEN = 7 days`，`T_PROGRESS = 14 days`，`T_REVIEW = 3 days`，`T_TERMINATE_RESPONSE = 48 hours`，`T_FIX_EXTENSION = 3 days`
20. **Request Fix 计时**：submittedAt 不刷新，验收截止 = `submittedAt + T_REVIEW + (fixRequested ? T_FIX_EXTENSION : 0)`
21. **agreeTerminate 时间检查**：前置条件包含 `block.timestamp <= terminateRequestedAt + T_TERMINATE_RESPONSE`
22. **链下 JSON schema**：
    - Profile 必填：`nickname`(string), `city`(string), `skills`(string[]), `encryptionPubKey`(string)
    - Task 必填：`title`(string), `description`(string), `contactsEncryptedPayload`(string), `createdAt`(uint256)
    - MVP 使用 contactsEncryptedPayload 直存，contactRef 为 V2 预留

---

## 2. 任务树校准后版本（P0/P1 精简）

### 2.1 Contracts（P0 核心 + P1 延后）

#### P0-C1: EOCHO Token 合约
- **目标**：实现 ERC20 Token，支持 cap、mintInitial、burn
- **依赖输入**：OpenZeppelin ERC20 库
- **产出物**：
  - `contracts/EOCHOToken.sol`
  - 状态变量：`CAP`(constant), `hasMintedInitial`(mapping), `registerAddress`, `taskEscrowAddress`
  - 函数：`mintInitial(address)`, `burn(uint256)`, 标准 ERC20 函数
  - 事件：`InitialMinted(address, uint256)`, `CapReached(address)`, `Burned(uint256)`
- **验收口径**：
  - PRD 1.4 所有常量值正确（INITIAL_MINT/CAP/FEE_BPS）
  - mintInitial 仅 registerAddress 可调用
  - burn 仅 taskEscrowAddress 可调用
  - CAP 已满时 mint 0 但不 revert，事件记录 mintedAmount=0

#### P0-C2: Register 合约
- **目标**：实现用户注册，存储 profileURI，触发 mintInitial
- **依赖输入**：EOCHO Token 合约地址，链下 profileURI（HTTP(S) 或 IPFS）
- **产出物**：
  - `contracts/Register.sol`
  - 状态变量：`echoToken`, `isRegistered`(mapping), `profileURI`(mapping)
  - 函数：`register(string _profileURI)`
  - 事件：`UserRegistered(address, string, uint256)`
- **验收口径**：
  - PRD 钉子 1：register() 是唯一入口，前端不得直接调用 mintInitial
  - 防重复注册（isRegistered 检查）
  - 成功后调用 echoToken.mintInitial(msg.sender)
  - 事件记录 mintedAmount（可能为 0）
  - **流程固定**：前端先上传 profile 到 backend 获取 URI，再调用 register(URI)

#### P0-C3: TaskEscrow 合约核心流程
- **目标**：实现任务创建、接受、提交、完成、取消及超时
- **依赖输入**：EOCHO Token 合约地址，Register 合约地址，链下 taskURI
- **产出物**：
  - `contracts/TaskEscrow.sol`
  - Task 结构体（13 个字段，PRD 5.2 定义）
  - 函数：`createTask`, `acceptTask`, `submitWork`, `confirmComplete`, `cancelTask`, `cancelTaskTimeout`, `completeTimeout`, `progressTimeout`
  - 事件：`TaskCreated`, `TaskAccepted`, `TaskSubmitted`, `TaskCompleted`, `TaskCancelled`
- **验收口径**：
  - PRD 5.2 所有函数前置条件、资金变化、事件完全一致
  - 状态机流转严格遵循 PRD 1.2 模块 3
  - 手续费计算：`fee = reward * 200 / 10000`
  - MAX_REWARD 硬限制生效
  - **流程固定**：前端先上传 task 到 backend 获取 URI，再调用 createTask(reward, URI)

#### P1-C4: TaskEscrow 协商终止机制
- **目标**：实现 requestTerminate, agreeTerminate, terminateTimeout
- **依赖输入**：Task 结构体中的 terminateRequestedBy, terminateRequestedAt
- **产出物**：
  - 函数：`requestTerminate`, `agreeTerminate`, `terminateTimeout`
  - 事件：`TerminateRequested`, `TerminateAgreed`
- **验收口径**：
  - PRD 2.11 协商终止流程完整实现
  - agreeTerminate 时间检查：`<= terminateRequestedAt + T_TERMINATE_RESPONSE`
  - terminateTimeout 重置字段后可再次请求

#### P1-C5: TaskEscrow Request Fix 机制
- **目标**：实现 requestFix，延长验收期
- **依赖输入**：Task 结构体中的 fixRequested, fixRequestedAt
- **产出物**：
  - 函数：`requestFix`
  - 事件：`FixRequested`
- **验收口径**：
  - PRD 2.12 请求修正流程完整实现
  - fixRequested 仅允许一次（前置条件：`fixRequested == false`）
  - submittedAt 不刷新
  - completeTimeout 计算包含 T_FIX_EXTENSION

---

### 2.2 Backend（P0 核心 + P1 加密）

#### P0-B1: Profile 存储服务
- **目标**：存储和查询用户 profile JSON
- **依赖输入**：用户提交的 profile 数据（nickname, city, skills, encryptionPubKey）
- **产出物**：
  - `backend/services/profileService.ts`
  - API: `POST /api/profile`, `GET /api/profile/:address`
  - 数据库表：`profiles` (address PK, nickname, city, skills JSON, encryptionPubKey, createdAt)
- **验收口径**：
  - PRD 4.3 Profile JSON schema 必填字段验证
  - encryptionPubKey 缺失时返回 400 错误
  - 返回的 profileURI 格式：`https://api.everecho.io/profile/{address}.json`
  - **实现选型待定**：encryptionPubKey 格式（hex/base64）和加密库（tweetnacl/@noble/curves）

#### P0-B2: Task Metadata 存储服务
- **目标**：存储和查询任务 JSON
- **依赖输入**：Creator 提交的任务数据（title, description, contacts）
- **产出物**：
  - `backend/services/taskService.ts`
  - API: `POST /api/task`, `GET /api/task/:taskId`
  - 数据库表：`tasks` (taskId PK, title, description, **contactsEncryptedPayload** TEXT, createdAt)
- **验收口径**：
  - PRD 4.3 Task JSON schema 必填字段验证
  - 返回的 taskURI 格式：`https://api.everecho.io/task/{taskId}.json`
  - contactsEncryptedPayload 字段存在

#### P1-B3: 联系方式加密服务
- **目标**：实现 DEK 生成、加密、包裹、解密流程
- **依赖输入**：Creator 和 Helper 的 encryptionPubKey（从 profile），任务状态（从链上），用户钱包签名（taskId）
- **产出物**：
  - `backend/services/encryptionService.ts`
  - API: `POST /api/contacts/encrypt`, `POST /api/contacts/decrypt`
  - 数据库表：`contact_keys` (taskId PK, creatorWrappedDEK, helperWrappedDEK)
- **验收口径**：
  - PRD 模块 3 加密方案完整实现
  - 使用 AES-256-GCM 加密联系方式
  - DEK 用双方 encryptionPubKey 分别包裹
  - 仅 InProgress/Submitted/Completed 状态允许解密
  - 签名验证包含 taskId
  - **实现选型待定**：加密库选型和密钥格式

#### P0-B4: 签名验证服务
- **目标**：验证用户钱包签名
- **依赖输入**：用户地址，签名消息（包含 taskId），签名
- **产出物**：
  - `backend/services/authService.ts`
  - 中间件：`verifySignature`
- **验收口径**：
  - 使用 ethers.js 验证签名
  - 签名消息格式统一（实现选型待定）
  - 验证失败返回 401

---

### 2.3 Frontend（P0 核心 + P1 体验）

#### P0-F1: 钱包连接与注册
- **目标**：实现钱包连接、注册流程
- **依赖输入**：MetaMask 等 Web3 钱包，Register 合约地址，Backend profile API
- **产出物**：
  - `frontend/pages/Home.tsx`, `frontend/pages/Register.tsx`
  - `frontend/hooks/useWallet.ts`, `frontend/hooks/useRegister.ts`
- **验收口径**：
  - PRD 2.1/2.2 用户流程完整实现
  - 连接钱包后检查 isRegistered
  - 注册表单包含：nickname, city, skills（多选）
  - 生成 encryptionPubKey 并上传（实现选型待定）
  - **流程固定**：先上传 profile 到 backend → 获取 URI → 调用 register(URI)
  - 成功后跳转任务广场

#### P0-F2: 任务广场与详情页
- **目标**：展示任务列表、详情、操作按钮
- **依赖输入**：TaskEscrow 合约事件（TaskCreated），Backend task API，链上任务状态
- **产出物**：
  - `frontend/pages/TaskSquare.tsx`, `frontend/pages/TaskDetail.tsx`
  - `frontend/components/TaskCard.tsx`, `frontend/hooks/useTasks.ts`
- **验收口径**：
  - PRD 3.1 Task Square 和 Task Detail 功能完整
  - 任务卡片显示：title, reward, creator tags, status
  - 详情页按钮根据状态和角色动态显示（PRD 3.1 Task Detail 完整映射）
  - 搜索/过滤功能（关键词、城市、技能、状态）

#### P0-F3: Profile 页面
- **目标**：展示用户信息和历史记录
- **依赖输入**：EOCHO Token 余额（链上），用户创建/接受的任务列表（链上事件），Backend profile API
- **产出物**：
  - `frontend/pages/Profile.tsx`, `frontend/components/TaskHistory.tsx`
- **验收口径**：
  - PRD 模块 2 Profile 功能完整
  - 显示：nickname, city, skills, EOCHO 余额
  - 两个标签页：我发布的任务、我接受的任务
  - 每条记录显示：title, status, 金额变动, 时间戳

#### P0-F4: 发布任务页面
- **目标**：实现任务发布表单
- **依赖输入**：EOCHO Token 余额（链上），TaskEscrow createTask 函数，Backend task API
- **产出物**：
  - `frontend/pages/PublishTask.tsx`, `frontend/hooks/useCreateTask.ts`
- **验收口径**：
  - PRD 2.3 Creator 发布任务流程完整
  - 表单：title, description, reward（数字输入），contacts（联系方式）
  - 前端检查余额 >= reward
  - **流程固定**：先上传 task 到 backend → 获取 URI → 调用 createTask(reward, URI)

#### P1-F5: 联系方式显示与解密
- **目标**：InProgress 后显示对方联系方式
- **依赖输入**：任务状态（链上），Backend contacts decrypt API，用户钱包签名
- **产出物**：
  - `frontend/components/ContactsDisplay.tsx`, `frontend/hooks/useContacts.ts`
- **验收口径**：
  - PRD 模块 3 联系方式显示功能
  - 仅 InProgress/Submitted/Completed 状态显示
  - 前端签名包含 taskId
  - 解密 DEK 并显示联系方式

#### P1-F6: 倒计时与超时提示
- **目标**：显示剩余时间和超时操作按钮
- **依赖输入**：任务时间戳（createdAt, acceptedAt, submittedAt），超时阈值（T_OPEN, T_PROGRESS, T_REVIEW）
- **产出物**：
  - `frontend/components/TimeoutIndicator.tsx`, `frontend/hooks/useTimeout.ts`
- **验收口径**：
  - PRD 3.1 Task Detail 超时提示功能
  - 显示剩余时间或"已超时"
  - 超时后显示"触发超时操作"按钮
  - 调用对应超时函数（cancelTaskTimeout, progressTimeout, completeTimeout）

#### P1-F7: 协商终止与 Request Fix UI
- **目标**：实现协商终止和请求修正按钮
- **依赖输入**：任务状态和字段（terminateRequestedBy, fixRequested），TaskEscrow 相关函数
- **产出物**：
  - `frontend/components/TerminateRequest.tsx`, `frontend/components/RequestFix.tsx`
- **验收口径**：
  - PRD 2.11/2.12 流程完整实现
  - InProgress 状态显示"请求终止任务"按钮
  - 有请求时对方显示"同意终止"按钮
  - Submitted 状态 Creator 显示"Request Fix"（未使用过）

---

### 2.4 QA/Test（P0 核心测试）

#### P0-T1: 合约单元测试
- **目标**：测试所有合约函数
- **依赖输入**：Hardhat 测试框架，部署的合约实例
- **产出物**：
  - `test/EOCHOToken.test.ts`, `test/Register.test.ts`, `test/TaskEscrow.test.ts`
- **验收口径**：
  - 覆盖所有函数的正常路径和异常路径
  - 测试所有前置条件（require/revert）
  - 验证所有事件触发
  - 验证资金流正确性（PRD 5.2 资金变化）
  - 测试覆盖率 > 90%

#### P0-T2: 状态机集成测试
- **目标**：测试完整任务生命周期
- **依赖输入**：部署的所有合约，多个测试账户
- **产出物**：
  - `test/integration/TaskLifecycle.test.ts`
- **验收口径**：
  - 测试 Open → InProgress → Submitted → Completed 完整流程
  - 测试所有取消/超时路径
  - 测试协商终止流程（P1）
  - 测试 Request Fix 流程（P1）
  - 验证每个状态的资金锁定和结算

---

## 3. 必要命名修正清单

### 3.1 字段/变量名（与 PRD 完全一致）

| 类别 | 名称 | PRD 位置 | 说明 |
|------|------|----------|------|
| 常量 | `INITIAL_MINT` | PRD 1.4 | 100 * 10**18 |
| 常量 | `CAP` | PRD 1.4 | 10_000_000 * 10**18 |
| 常量 | `FEE_BPS` | PRD 1.4 | 200（2%） |
| 常量 | `MAX_REWARD` | PRD 1.4 | 1000 * 10**18 |
| 常量 | `T_OPEN` | PRD 1.4 | 7 days |
| 常量 | `T_PROGRESS` | PRD 1.4 | 14 days |
| 常量 | `T_REVIEW` | PRD 1.4 | 3 days |
| 常量 | `T_TERMINATE_RESPONSE` | PRD 1.4 | 48 hours |
| 常量 | `T_FIX_EXTENSION` | PRD 1.4 | 3 days |
| 状态枚举 | `TaskStatus` | PRD 5.2 | Open, InProgress, Submitted, Completed, Cancelled |
| 字段 | `taskId` | PRD 4.1 | uint256 |
| 字段 | `creator` | PRD 4.1 | address |
| 字段 | `helper` | PRD 4.1 | address |
| 字段 | `reward` | PRD 4.1 | uint256 |
| 字段 | `taskURI` | PRD 4.1 | string |
| 字段 | `status` | PRD 4.1 | TaskStatus |
| 字段 | `createdAt` | PRD 4.1 | uint256 |
| 字段 | `acceptedAt` | PRD 4.1 | uint256 |
| 字段 | `submittedAt` | PRD 4.1 | uint256 |
| 字段 | `terminateRequestedBy` | PRD 4.1 | address |
| 字段 | `terminateRequestedAt` | PRD 4.1 | uint256 |
| 字段 | `fixRequested` | PRD 4.1 | bool |
| 字段 | `fixRequestedAt` | PRD 4.1 | uint256 |
| 字段 | `profileURI` | PRD 4.3 | string |
| 字段 | `isRegistered` | PRD 4.1 | bool |
| 字段 | `hasMintedInitial` | PRD 5.1 | bool |

### 3.2 JSON Schema 字段（与 PRD 完全一致）

| JSON 类型 | 字段名 | 类型 | PRD 位置 |
|-----------|--------|------|----------|
| Profile | `nickname` | string | PRD 4.3 |
| Profile | `city` | string | PRD 4.3 |
| Profile | `skills` | string[] | PRD 4.3 |
| Profile | `encryptionPubKey` | string | PRD 4.3 |
| Task | `title` | string | PRD 4.3 |
| Task | `description` | string | PRD 4.3 |
| Task | `contactsEncryptedPayload` | string | PRD 4.3 |
| Task | `createdAt` | uint256 | PRD 4.3 |

### 3.3 事件名（与 PRD 完全一致）

| 事件名 | 参数 | PRD 位置 |
|--------|------|----------|
| `InitialMinted` | (address indexed to, uint256 amount) | PRD 5.1 |
| `CapReached` | (address indexed attemptedBy) | PRD 5.1 |
| `Burned` | (uint256 amount) | PRD 5.1 |
| `UserRegistered` | (address indexed user, string profileURI, uint256 mintedAmount) | PRD 5.3 |
| `TaskCreated` | (uint256 indexed taskId, address indexed creator, uint256 reward, string taskURI) | PRD 5.2 |
| `TaskAccepted` | (uint256 indexed taskId, address indexed helper) | PRD 5.2 |
| `TaskSubmitted` | (uint256 indexed taskId) | PRD 5.2 |
| `TaskCompleted` | (uint256 indexed taskId, uint256 helperReceived, uint256 feeBurned) | PRD 5.2 |
| `TaskCancelled` | (uint256 indexed taskId, string reason) | PRD 5.2 |
| `TerminateRequested` | (uint256 indexed taskId, address indexed requestedBy) | PRD 5.2 |
| `TerminateAgreed` | (uint256 indexed taskId) | PRD 5.2 |
| `FixRequested` | (uint256 indexed taskId) | PRD 5.2 |

### 3.4 函数名（与 PRD 完全一致）

| 函数名 | 合约 | PRD 位置 |
|--------|------|----------|
| `mintInitial` | EOCHOToken | PRD 5.1 |
| `burn` | EOCHOToken | PRD 5.1 |
| `register` | Register | PRD 5.3 |
| `createTask` | TaskEscrow | PRD 5.2 |
| `acceptTask` | TaskEscrow | PRD 5.2 |
| `submitWork` | TaskEscrow | PRD 5.2 |
| `confirmComplete` | TaskEscrow | PRD 5.2 |
| `cancelTask` | TaskEscrow | PRD 5.2 |
| `cancelTaskTimeout` | TaskEscrow | PRD 5.2 |
| `completeTimeout` | TaskEscrow | PRD 5.2 |
| `progressTimeout` | TaskEscrow | PRD 5.2 |
| `requestTerminate` | TaskEscrow | PRD 5.2 |
| `agreeTerminate` | TaskEscrow | PRD 5.2 |
| `terminateTimeout` | TaskEscrow | PRD 5.2 |
| `requestFix` | TaskEscrow | PRD 5.2 |

### 3.5 数据库表名（校准后）

| 旧名称（工程草案） | 新名称（校准后） | 说明 |
|-------------------|-----------------|------|
| `profiles` | `profiles` | ✅ 保持不变 |
| `tasks` | `tasks` | ✅ 保持不变 |
| `contact_keys` | `contact_keys` | ✅ 保持不变 |
| `contactsEncrypted` | `contactsEncryptedPayload` | ❌ 修正：字段名与 PRD 4.3 一致 |

---

## 4. 仍残留的实现选型问题（3 条）

### 4.1 encryptionPubKey 生成与格式
**PRD 未冻结内容**：PRD 4.3 仅规定 profile JSON 必须包含 `encryptionPubKey`（x25519 或 secp256k1-encryption key），但未明确：
- 前端使用哪个加密库生成密钥对？
- encryptionPubKey 的格式（hex/base64/PEM）？
- 如何从用户钱包派生加密密钥对？

**实现选型待定**：
- **推荐方案 A**：使用 tweetnacl.js 生成 x25519 密钥对，encryptionPubKey 为 base64 编码的公钥（32 字节）
- **推荐方案 B**：使用 @noble/curves 生成 secp256k1 加密密钥对，encryptionPubKey 为 hex 编码的公钥（33 字节压缩格式）
- **不影响冻结语义**：无论选择哪种方案，PRD 中的加密流程（DEK 包裹、AES-256-GCM）保持不变

### 4.2 URI 生成时机与幂等性
**PRD 未冻结内容**：PRD 4.3 给出了 URI 示例格式，但未明确：
- 前端调用 register()/createTask() 前是否必须先上传到 backend？
- 如果 backend 服务挂了，register() 已成功但 profile 未存储，如何处理？
- backend 如何保证幂等性（同一地址多次上传 profile）？

**实现选型待定**：
- **推荐流程**：前端先上传 → backend 返回 URI → 前端调用合约函数（URI）
- **幂等性策略**：backend 以 address/taskId 为主键，重复上传覆盖旧数据
- **失败处理**：如果 backend 挂了，前端提示用户稍后重试，不调用合约函数
- **URI 与 API 路径区分**：profileURI/taskURI 为对外静态 JSON 地址（如 `https://api.everecho.io/profile/{address}.json`），不等同于 POST API 路径（`/api/profile`, `/api/task`）
- **不影响冻结语义**：PRD 中的链上/链下边界（链上存 URI，链下存 JSON）保持不变

### 4.3 签名消息格式
**PRD 未冻结内容**：PRD 模块 3 规定"前端用户通过钱包签名验证身份（签名消息包含 taskId）"，但未明确：
- 签名消息的具体格式（EIP-191/EIP-712）？
- 签名消息是否包含其他字段（timestamp/nonce）？
- 如何防止签名重放攻击？

**实现选型待定**：
- **推荐方案 A**：使用 EIP-191 个人签名，消息格式：`"EverEcho: Decrypt contacts for task ${taskId}"`
- **推荐方案 B**：使用 EIP-712 结构化签名，包含 taskId、timestamp、chainId
- **重放攻击防护**：backend 记录已使用的签名（或使用 timestamp 过期机制）
- **不影响冻结语义**：PRD 中的签名验证流程（验证签名 + 检查任务状态）保持不变

---

## 5. 删除/降级的内容（超出 MVP 范围）

### 5.1 从 P0 降级为 V2/不在范围
- ❌ **Profile 更新功能**：PRD 4.2 明确"MVP 阶段 profileURI 不可变且不提供编辑入口"
- ❌ **任务搜索/过滤优化**：PRD 附录标注为 P2，MVP 仅实现基础搜索
- ❌ **用户信誉系统**：PRD 附录标注为 P2
- ❌ **Gas 费用优化（Layer 2）**：PRD 附录标注为 P2
- ❌ **争议仲裁机制**：PRD 附录标注为 V2

### 5.2 从工程草案删除的内容
- ❌ **风险 3：超时函数的 Gas 费承担**：PRD 未冻结，MVP 接受"触发者自付 Gas"
- ❌ **风险 4：Request Fix 的链下更新验证**：PRD 未冻结，MVP 信任 Helper 诚信
- ❌ **风险 5：合约部署顺序**：已在薄片定稿 1.1 第 1 条明确，不再作为风险

### 5.3 保留但标注为"实现选型待定"的内容
- ⚠️ **encryptionPubKey 生成与格式**：见 4.1
- ⚠️ **URI 生成时机与幂等性**：见 4.2
- ⚠️ **签名消息格式**：见 4.3

---

## 6. 最小 Repo 目录结构（精简版）

```
everecho-mvp/
├── contracts/
│   ├── EOCHOToken.sol
│   ├── Register.sol
│   ├── TaskEscrow.sol
│   └── interfaces/
│       ├── IEOCHOToken.sol
│       ├── IRegister.sol
│       └── ITaskEscrow.sol
├── scripts/
│   ├── deploy.ts
│   └── config.ts
├── test/
│   ├── EOCHOToken.test.ts
│   ├── Register.test.ts
│   ├── TaskEscrow.test.ts
│   └── integration/
│       └── TaskLifecycle.test.ts
├── backend/
│   ├── src/
│   │   ├── services/
│   │   │   ├── profileService.ts
│   │   │   ├── taskService.ts
│   │   │   ├── encryptionService.ts
│   │   │   └── authService.ts
│   │   ├── routes/
│   │   │   ├── profile.ts
│   │   │   ├── task.ts
│   │   │   └── contacts.ts
│   │   ├── models/
│   │   │   ├── Profile.ts
│   │   │   ├── Task.ts
│   │   │   └── ContactKey.ts
│   │   ├── middleware/
│   │   │   └── verifySignature.ts
│   │   └── index.ts
│   ├── prisma/
│   │   └── schema.prisma
│   └── package.json
├── frontend/
│   ├── src/
│   │   ├── pages/
│   │   │   ├── Home.tsx
│   │   │   ├── Register.tsx
│   │   │   ├── TaskSquare.tsx
│   │   │   ├── TaskDetail.tsx
│   │   │   ├── Profile.tsx
│   │   │   └── PublishTask.tsx
│   │   ├── components/
│   │   │   ├── WalletConnect.tsx
│   │   │   ├── TaskCard.tsx
│   │   │   ├── TaskHistory.tsx
│   │   │   ├── ContactsDisplay.tsx
│   │   │   ├── TimeoutIndicator.tsx
│   │   │   ├── TerminateRequest.tsx
│   │   │   └── RequestFix.tsx
│   │   ├── hooks/
│   │   │   ├── useWallet.ts
│   │   │   ├── useRegister.ts
│   │   │   ├── useTasks.ts
│   │   │   ├── useTaskDetail.ts
│   │   │   ├── useCreateTask.ts
│   │   │   ├── useContacts.ts
│   │   │   └── useTimeout.ts
│   │   ├── contracts/
│   │   │   ├── EOCHOToken.json
│   │   │   ├── Register.json
│   │   │   ├── TaskEscrow.json
│   │   │   └── addresses.ts
│   │   └── App.tsx
│   └── package.json
├── hardhat.config.ts
├── .env.example
└── README.md
```

---

## 7. 下一步：拆解为 vibe coding prompts

### Step 1: 合约开发（P0-C1/C2/C3）
**Prompt 模板**：
```
基于 PRD v1.2 和薄片校准定稿 v1.0，实现 [EOCHOToken/Register/TaskEscrow] 合约。

必须遵守：
- 薄片定稿 1.1-1.4 所有冻结点
- PRD 5.[1/2/3] 所有函数签名、前置条件、资金变化、事件
- 命名必须与薄片定稿 3.1-3.4 完全一致

验收标准：
- [具体验收口径，从薄片定稿 2.1 复制]
```

### Step 2: Backend 开发（P0-B1/B2/B4）
**Prompt 模板**：
```
基于 PRD v1.2 和薄片校准定稿 v1.0，实现 [Profile/Task/Auth] 存储服务。

必须遵守：
- 薄片定稿 1.4 第 22 条 JSON schema
- 薄片定稿 3.2 字段命名
- 流程固定：前端先上传 → backend 返回 URI → 前端调用合约

验收标准：
- [具体验收口径，从薄片定稿 2.2 复制]
```

### Step 3: Frontend 开发（P0-F1/F2/F3/F4）
**Prompt 模板**：
```
基于 PRD v1.2 和薄片校准定稿 v1.0，实现 [Home/Register/TaskSquare/Profile/PublishTask] 页面。

必须遵守：
- PRD 第 2 章用户流程
- 薄片定稿 3.3 事件名、3.4 函数名
- 流程固定：先上传到 backend → 获取 URI → 调用合约函数

验收标准：
- [具体验收口径，从薄片定稿 2.3 复制]
```

---

**薄片校准定稿状态**：✅ 已完成，可直接驱动 vibe coding  
**下次更新**：实现过程中如发现 PRD 歧义，仅做一句话级别补强
